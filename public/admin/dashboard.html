<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - The News Curator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: 'Inter', sans-serif;
      }
      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .article-row:hover {
        background-color: #f9fafb;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <div class="min-h-screen">
      <!-- Header -->
      <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex justify-between items-center py-4">
            <div class="flex items-center">
              <h1 class="text-2xl font-bold text-gray-900">Admin Dashboard</h1>
            </div>
            <nav class="flex space-x-4">
              <a href="/admin/dashboard.html" class="text-blue-600 font-medium"
                >Dashboard</a
              >
              <a
                href="/admin/editor.html"
                class="text-gray-600 hover:text-blue-600"
                >Create Article</a
              >
              <a href="/" class="text-gray-600 hover:text-blue-600"
                >View Site</a
              >
              <button id="logoutBtn" class="text-gray-600 hover:text-red-600">
                Logout
              </button>
            </nav>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="stat-card rounded-lg p-6 text-white">
            <div class="flex items-center">
              <div class="flex-1">
                <p class="text-white/80 text-sm font-medium">Total Articles</p>
                <p id="totalArticles" class="text-3xl font-bold">0</p>
              </div>
            </div>
          </div>
          <div class="bg-green-500 rounded-lg p-6 text-white">
            <div class="flex items-center">
              <div class="flex-1">
                <p class="text-white/80 text-sm font-medium">
                  Featured Articles
                </p>
                <p id="featuredArticles" class="text-3xl font-bold">0</p>
              </div>
            </div>
          </div>
          <div class="bg-purple-500 rounded-lg p-6 text-white">
            <div class="flex items-center">
              <div class="flex-1">
                <p class="text-white/80 text-sm font-medium">Total Views</p>
                <p id="totalViews" class="text-3xl font-bold">0</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Articles Management -->
        <div class="bg-white shadow rounded-lg">
          <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex justify-between items-center">
              <h2 class="text-lg font-medium text-gray-900">
                Article Management
              </h2>
              <div class="flex space-x-4">
                <!-- Filters -->
                <select
                  id="categoryFilter"
                  class="border border-gray-300 rounded-md px-3 py-2 text-sm"
                >
                  <option value="">All Categories</option>
                  <option value="Politics">Politics</option>
                  <option value="Science">Science</option>
                  <option value="Technology">Technology</option>
                  <option value="Business">Business</option>
                </select>
                <select
                  id="statusFilter"
                  class="border border-gray-300 rounded-md px-3 py-2 text-sm"
                >
                  <option value="">All Status</option>
                  <option value="published">Published</option>
                  <option value="unpublished">Unpublished</option>
                  <option value="featured">Featured</option>
                  <option value="regular">Regular</option>
                </select>
                <!-- Bulk Actions -->
                <select
                  id="bulkAction"
                  class="border border-gray-300 rounded-md px-3 py-2 text-sm"
                >
                  <option value="">Bulk Actions</option>
                  <option value="publish">Publish</option>
                  <option value="unpublish">Unpublish</option>
                  <option value="feature">Mark as Featured</option>
                  <option value="unfeature">Remove Featured</option>
                  <option value="delete">Delete Selected</option>
                </select>
                <button
                  id="applyBulkAction"
                  class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm hover:bg-blue-700"
                >
                  Apply
                </button>
              </div>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    <input
                      type="checkbox"
                      id="selectAll"
                      class="rounded border-gray-300"
                    />
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Title
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Category
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Author
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Published
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Views
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Status
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Actions
                  </th>
                </tr>
              </thead>
              <tbody
                id="articlesTableBody"
                class="bg-white divide-y divide-gray-200"
              >
                <!-- Articles will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </main>
    </div>

    <script>
      let articles = [];
      let filteredArticles = [];

      // Check authentication on page load
      async function checkAuth() {
        try {
          const response = await fetch('/api/auth/status', {
            credentials: 'include',
          });
          const data = await response.json();

          if (!data.authenticated) {
            window.location.href = '/admin/login.html';
            return false;
          }
          return true;
        } catch (error) {
          console.error('Auth check failed:', error);
          window.location.href = '/admin/login.html';
          return false;
        }
      }

      // Load articles and stats
      async function loadDashboard() {
        try {
          const response = await fetch('/api/articles', {
            credentials: 'include',
          });

          if (response.status === 401) {
            window.location.href = '/admin/login.html';
            return;
          }

          articles = await response.json();
          filteredArticles = [...articles];

          updateStats();
          updateArticlesTable();
        } catch (error) {
          console.error('Error loading dashboard:', error);
          showNotification('Failed to load dashboard', 'error');
        }
      }

      // Update statistics
      function updateStats() {
        const totalArticles = filteredArticles.length;
        const featuredArticles = filteredArticles.filter(
          (a) => a.featured
        ).length;
        const totalViews = filteredArticles.reduce(
          (sum, a) => sum + a.viewCount,
          0
        );

        document.getElementById('totalArticles').textContent = totalArticles;
        document.getElementById('featuredArticles').textContent =
          featuredArticles;
        document.getElementById('totalViews').textContent =
          totalViews.toLocaleString();
      }

      // Update articles table
      function updateArticlesTable() {
        const tbody = document.getElementById('articlesTableBody');

        if (filteredArticles.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                No articles found. <a href="/admin/editor.html" class="text-blue-600 hover:underline">Create your first article</a>
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = filteredArticles
          .map(
            (article) => `
              <tr class="article-row">
                <td class="px-6 py-4 whitespace-nowrap">
                  <input type="checkbox" class="article-checkbox rounded border-gray-300" value="${
                    article._id
                  }">
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm font-medium text-gray-900">${
                    article.title
                  }</div>
                  <div class="text-sm text-gray-500">${article.excerpt.substring(
                    0,
                    60
                  )}...</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                    ${article.category}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${
                  article.author
                }</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  ${new Date(article.publishedAt).toLocaleDateString()}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${
                  article.viewCount
                }</td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex flex-col space-y-1">
                    ${
                      article.published !== false
                        ? '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Published</span>'
                        : '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Unpublished</span>'
                    }
                    ${
                      article.featured
                        ? '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Featured</span>'
                        : ''
                    }
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                  <div class="flex flex-col space-y-1">
                    <div>
                      <a href="/article.html?slug=${
                        article.slug
                      }" class="text-blue-600 hover:text-blue-900 mr-2" target="_blank">View</a>
                      <button onclick="editArticle('${
                        article._id
                      }')" class="text-green-600 hover:text-green-900 mr-2">Edit</button>
                    </div>
                    <div>
                      <button onclick="togglePublish('${article._id}', ${
              article.published !== false
            })" class="text-purple-600 hover:text-purple-900 mr-2">
                        ${article.published !== false ? 'Unpublish' : 'Publish'}
                      </button>
                      <button onclick="deleteArticle('${article._id}', '${
              article.title
            }')" class="text-red-600 hover:text-red-900">Delete</button>
                    </div>
                  </div>
                </td>
              </tr>
            `
          )
          .join('');
      }

      // Filter articles
      function filterArticles() {
        const categoryFilter = document.getElementById('categoryFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;

        filteredArticles = articles.filter((article) => {
          const matchesCategory =
            !categoryFilter || article.category === categoryFilter;
          const matchesStatus =
            !statusFilter ||
            (statusFilter === 'published' && article.published !== false) ||
            (statusFilter === 'unpublished' && article.published === false) ||
            (statusFilter === 'featured' && article.featured) ||
            (statusFilter === 'regular' && !article.featured);

          return matchesCategory && matchesStatus;
        });

        updateStats();
        updateArticlesTable();
      }

      // Handle bulk actions
      async function applyBulkAction() {
        const action = document.getElementById('bulkAction').value;
        const selectedIds = Array.from(
          document.querySelectorAll('.article-checkbox:checked')
        ).map((cb) => cb.value);

        if (!action || selectedIds.length === 0) {
          showNotification('Please select articles and an action', 'error');
          return;
        }

        if (
          action === 'delete' &&
          !confirm(
            `Are you sure you want to delete ${selectedIds.length} articles?`
          )
        ) {
          return;
        }

        try {
          for (const id of selectedIds) {
            if (action === 'feature' || action === 'unfeature') {
              const article = articles.find((a) => a._id === id);
              await fetch(`/api/articles/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                  ...article,
                  featured: action === 'feature',
                }),
              });
            } else if (action === 'publish' || action === 'unpublish') {
              const article = articles.find((a) => a._id === id);
              await fetch(`/api/articles/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                  ...article,
                  published: action === 'publish',
                }),
              });
            } else if (action === 'delete') {
              await fetch(`/api/articles/${id}`, {
                method: 'DELETE',
                credentials: 'include',
              });
            }
          }

          showNotification(`Bulk action completed successfully`, 'success');
          await loadDashboard();

          // Reset selections
          document.getElementById('bulkAction').value = '';
          document.getElementById('selectAll').checked = false;
        } catch (error) {
          console.error('Bulk action failed:', error);
          showNotification('Bulk action failed', 'error');
        }
      }

      // Edit article
      function editArticle(articleId) {
        window.location.href = `/admin/editor.html?id=${articleId}`;
      }

      // Toggle publish status
      async function togglePublish(articleId, isCurrentlyPublished) {
        try {
          const article = articles.find((a) => a._id === articleId);
          const response = await fetch(`/api/articles/${articleId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              ...article,
              published: !isCurrentlyPublished,
            }),
          });

          if (response.ok) {
            await loadDashboard();
            showNotification(
              `Article ${
                !isCurrentlyPublished ? 'published' : 'unpublished'
              } successfully`,
              'success'
            );
          } else {
            showNotification('Failed to update article status', 'error');
          }
        } catch (error) {
          console.error('Toggle publish failed:', error);
          showNotification('Failed to update article status', 'error');
        }
      }

      // Delete article
      async function deleteArticle(articleId, title) {
        if (!confirm(`Are you sure you want to delete "${title}"?`)) {
          return;
        }

        try {
          const response = await fetch(`/api/articles/${articleId}`, {
            method: 'DELETE',
            credentials: 'include',
          });

          if (response.ok) {
            await loadDashboard();
            showNotification('Article deleted successfully', 'success');
          } else {
            showNotification('Error deleting article', 'error');
          }
        } catch (error) {
          console.error('Error deleting article:', error);
          showNotification('Error deleting article', 'error');
        }
      }

      // Logout
      async function logout() {
        try {
          await fetch('/api/auth/logout', {
            method: 'POST',
            credentials: 'include',
          });
          window.location.href = '/admin/login.html';
        } catch (error) {
          console.error('Logout failed:', error);
          window.location.href = '/admin/login.html';
        }
      }

      // Show notification
      function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 px-4 py-2 rounded-md text-white z-50 ${
          type === 'success'
            ? 'bg-green-500'
            : type === 'error'
            ? 'bg-red-500'
            : 'bg-blue-500'
        }`;
        notification.textContent = message;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.remove();
        }, 3000);
      }

      // Initialize dashboard
      document.addEventListener('DOMContentLoaded', async function () {
        if (await checkAuth()) {
          await loadDashboard();

          // Setup event listeners
          document
            .getElementById('categoryFilter')
            .addEventListener('change', filterArticles);
          document
            .getElementById('statusFilter')
            .addEventListener('change', filterArticles);
          document
            .getElementById('applyBulkAction')
            .addEventListener('click', applyBulkAction);
          document
            .getElementById('logoutBtn')
            .addEventListener('click', logout);

          // Select all checkbox
          document
            .getElementById('selectAll')
            .addEventListener('change', function () {
              const checkboxes = document.querySelectorAll('.article-checkbox');
              checkboxes.forEach((cb) => (cb.checked = this.checked));
            });
        }
      });
    </script>
  </body>
</html>
